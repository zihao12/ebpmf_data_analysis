---
title: "ebpmf_wbg_description"
author: "zihao12"
date: "2020-10-26"
output: workflowr::wflow_html
header-includes:
   - \usepackage{bbm}
editor_options:
  chunk_output_type: console
---

## Model

\begin{align}
  & X_{ij} \sim \mathrm{Pois}(\lambda_{ij})\\
  & \lambda_{ij} = l_{i0} f_{j0} \sum_k w_k l_{ik} f_{jk}\\
  & l_{ik} \sim g_{L, k}(.), f_{jk} \sim g_{F, k}(.)\\
  & g_{L, k}(.), g_{F,k}(.) \in \mathcal{G}
\end{align}

* If we introduce hidden variable $Z$: $X_{ij} = \sum_k Z_{ijk}$, we can interpret the mean of $Z_{ijk}$ as the product of the background frequency ($(l_{i0} f_{j0})$) and the deviation from that ($\sum_k w_k l_{ik} f_{jk}$). 

* If $w_k = 1/K$ and $l_{ik} = f_{jk} = 1$ (the $g$'s put most mass around $1$), we have $X_{ij} \sim \mathrm{Pois}(l_{i0} f_{j0})$. This is just rank-1 PMF with solution $l_{i0} \propto \sum_{j} X_{ij}, f_{j0} \propto \sum_{i} X_{ij}$ and $(\sum_i l_{i0}) * (\sum_j f_{j0}) = \sum_{i, j} X_{ij}$. 

* We assume another version of "sparsity" here: for each $k$, majority of the deviation $l_{ik}$ would be close to 1; only a small proportion of top documents have larger deviation from background. Same assumption for factors. 

* Interpretation: if cell/document $i$ is activated in topic/biological process $k$, then $l_{ik}$ will be larger than $1$; if it's de-activated then $l_{ik}$ will be smaller than $1$. Similarly, if word/gene $j$ is overexpressed in topic/biological process $k$, then $f_{jk}$ will be larger than $1$; if it's less-expressed then $f_{jk}$ will be smaller than $1$. 

* In a simplifying case where $g_{L, k}$ has 2 components for close to/deviate from $1$, then we estimate the proportions of average & activated/de-activated samples in that topic. Similar interpretation for $g_{F, k}$. 

* I think `ebpmf-wbg` is interpretable in itself (transforming into multinomial model loses some information), whereas ordinary PMF is harder to interpret without some scaling.  

* We impose this assumption through $\mathcal{G}$, dicussed in the next section

The algorithm for solving the model can be seen [algorithm](https://github.com/stephenslab/ebpmf.alpha/blob/master/derivations/ebpmf_wbg.pdf)

## Prior family $\mathcal{G}$

\begin{align}
  \mathcal{G} = \{g: g(.) = \sum_{l} \pi_l \mathrm{Ga}(.; 1/\phi_l, 1/\phi_l)\}
\end{align}

For a random variable $X \sim \mathrm{Ga}(.; 1/\phi_l, 1/\phi_l)$, we have
\begin{align}
  & \mathrm{E}(X) = 1\\
  & \mathrm{Var}(X) = \phi\\
  & \mathrm{Mode}(X) = max(0, 1 - \phi)
\end{align}

Below I show the density for different $\phi$s. Note that the first one is a bit deceptive about the tail. 
```{r}
rm(list = ls())
par(las=1)
phis <- c(0.01, 0.9, 1, 10)
cols <- c("black", "red", "blue","green")

for(i in 1:length(phis)){
  if(i != 1){
    par(new = TRUE)
    plot(function(x) (dgamma(x, shape = 1/phis[i], rate = 1/phis[i])), 
     from = 0.001, to = 10, ylab = "dgamma", col = cols[i], axes = FALSE )
  }else{
    plot(function(x) (dgamma(x, shape = 1/phis[i], rate = 1/phis[i])), 
     from = 0.001, to = 10, ylab = "dgamma", col = cols[i])
  }
}
legend("topright", legend = paste("phi = ", phis), col = cols, lty=1, cex=0.8)
```

look at the tail
```{r}
for(i in 1:length(phis)){
  if(i != 1){
    par(new = TRUE)
    plot(function(x) (dgamma(x, shape = 1/phis[i], rate = 1/phis[i])), 
     from = 5, to = 20, ylab = "dgamma", col = cols[i], axes = FALSE )
  }else{
    plot(function(x) (dgamma(x, shape = 1/phis[i], rate = 1/phis[i])), 
     from = 5, to = 20, ylab = "dgamma", col = cols[i])
  }
}
legend("topright", legend = paste("phi = ", phis), col = cols, lty=1, cex=0.8)
```

* when $\phi < 1$ it is concentrated near 1; 
* when $\phi > 1$ it favors points near $0$, as well as larger points (compared to other smaller $\phi1$). 



