---
title: "news_ebpmf_wbg_k20"
author: "Zihao"
date: "2020-09-27"
output: workflowr::wflow_html
---

## Introduction
I  applied [ebpmf_wbg](https://github.com/stephenslab/ebpmf.alpha/blob/master/R/ebpmf_wbg.R) (with $k = 20$) to [news](https://github.com/stephenslab/topics/prepare_news_data.html) dataset. let's see the results.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold", fig.align = "center",dpi = 120)
```

```{r load-pkgs, message = FALSE}
#setwd("~/Desktop/git/ebpmf_data_analysis/")
library(Matrix)
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
library(CountClust)
source("code/plots.R")
source("code/util.R")
source("code/misc.R")
set.seed(123)

version = "v0.4.5"
method_name = "ebpmf_wbg"
data_name = "news"
dir_name = "News"
K = 20
maxiter = 2000
```


## load data and fitted model
Note that: $X_{ij} \sim  Pois(\sum_k w_k l_{i0} l_{ik} f_{j0} f_{jk})$. I use $\text{loading}_{ik} = w_k l_{ik}$ then scale it so that each row sums to 1. There are other ways to get a meaningful loading...

```{r}
X = read_news_bag_of_words(sprintf("data/%s/docword.%s.txt", dir_name, data_name))
vocab = readLines(sprintf("data/%s/vocab.%s.txt", dir_name, data_name))
labels = readLines(sprintf("data/%s/topics.%s.txt", dir_name, data_name))

## data size
print(dim(X))
## percentage of nonzero elements
print(length(X@x)/(nrow(X) * ncol(X)))

## unique topics (20 of them, same as K used in the model)
print(unique(labels))
```


```{r load-model}
model = readRDS(sprintf("output/%s/%s/%s_%s_initLF50_K%d_maxiter%d.Rds", dir_name, version, data_name, method_name, K, maxiter))
L_scaled = model$qg$qls_mean %*% diag(model$w)
L_scaled = L_scaled/rowSums(L_scaled)
fit = list(L = L_scaled)
```

## Meaning of topics:
See [topicView](https://zihao12.shinyapps.io/topicview-app/) (more info to add)

## Visualization of $L$ {.tabset}

### Hierarchical Clustering
```{r Heatmap, fig.width=15, fig.height=10}
## use code from https://stephenslab.github.io/count-clustering/project/src/gtex_v6_structure_genes.html
rows <- c()
for(label in unique(labels)){
  rows <- c(rows, sample(which(labels == label), size = 50))
}

omega = fit$L[rows, ]
colnames(omega) <- c(1:NCOL(omega))
rownames(omega) <- c(1:NROW(omega))

#find sample orders in hierarchical clustering
docweights_per_tissue_mean <- apply(omega, 2,
                                    function(x) { tapply(x, labels[rows], mean) })
ordering <- heatmap(docweights_per_tissue_mean)$rowInd
```

### Structure Plot
```{r StructurePlot, fig.width=10, fig.height=20, warning=FALSE}
levels_reordered <- unique(labels)[ordering]

annotation <- data.frame(
    sample_id = paste0("X", 1:length(labels[rows])),
    tissue_label = factor(labels[rows], levels = rev(levels_reordered)))

StructureGGplot(omega = omega, annotation = annotation, 
                palette = c(RColorBrewer::brewer.pal(12, "Paired"), RColorBrewer::brewer.pal(8, "Accent")),
                yaxis_label = "",
                order_sample = TRUE,
                split_line = list(split_lwd = .1,
                                  split_col = "white"),
                axis_tick = list(axis_ticks_length = .1,
                                 axis_ticks_lwd_y = .5,
                                 axis_ticks_lwd_x = .5,
                                 axis_label_size = 5,
                                 axis_label_face="bold"))
```




### t-SNE plots
```{r tsne-plot1, fig.width=10, fig.height=24}
p12 <- my_tsne_plot(fit,k = 1:K,num_threads = 8,verbose = FALSE)
print(p12)
```

### PCA plots
```{r}
lams = svd(x = L_scaled)$d
plot(1:length(lams), lams/sum(lams), xlab = "eigen idx", ylab = "prop of variance explained")
```


<!-- ```{r clustering-1, fig.width=8, fig.height=2.5} -->
<!-- p1 <- basic_pca_plot(fit,1:2) -->
<!-- p2 <- basic_pca_plot(fit,3:4) -->
<!-- p3 <- basic_pca_plot(fit,5:6) -->
<!-- plot_grid(p1,p2,p3,nrow = 1,ncol = 3) -->
<!-- ``` -->

PCA plots (Show the density of the points by “hexbin” plots)
```{r clustering-2, fig.width=8, fig.height=2.5}
bins <- c(0,1,5,10,100,Inf)
p4 <- pca_hexbin_plot(fit,1:2,bins = bins) + guides(fill = "none")
p5 <- pca_hexbin_plot(fit,3:4,bins = bins) + guides(fill = "none")
p6 <- pca_hexbin_plot(fit,5:6,bins = bins) + guides(fill = "none")
plot_grid(p4,p5,p6,nrow = 1,ncol = 3)
```

Show where each topic lies in PC1-PC2 space
```{r clustering-3, fig.width=5.5, fig.height=24}
p9 <- my_pca_plot(fit,pcs = 1:2,k = 1:K)
print(p9)
```


## about `g`
$l_{ik} \sim \pi_{kl} Ga(1/\phi_{kl}, 1/\phi_{kl})$. Note $Var(X) = \phi, X \sim Ga(1/\phi, 1/\phi)$, and for very big $\phi$, the mass is almost all on 0. 
```{r}
get_prior_summary(model$qg$gls)
get_prior_summary(model$qg$gfs)
```


